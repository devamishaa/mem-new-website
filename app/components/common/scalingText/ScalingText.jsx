"use client";

import React, { useEffect, useRef } from "react";
import { gsap } from "@/utils/gsap";
import CdnImage from "@/app/components/common/CdnImage";

const ScalingText = ({ onScaleChange }) => {
  const logoContainerRef = useRef(null);

  useEffect(() => {
    if (!logoContainerRef.current) return;

    // Use GSAP's quickTo for performant animations
    const quickScale = gsap.quickTo(logoContainerRef.current, "scaleY", {
      duration: 0.4,
      ease: "power2.out",
    });

    const handleScroll = () => {
      if (!logoContainerRef.current) return;

      // Check if scrolled to the bottom of the page
      if (
        window.innerHeight + window.scrollY >=
        document.body.offsetHeight - 5
      ) {
        quickScale(1);
        // Notify parent that we're in final state
        if (onScaleChange) {
          onScaleChange(1, true); // true indicates final state
        }
        return;
      }

      const rect = logoContainerRef.current.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const elementCenter = rect.top + rect.height / 2;
      const plateauStart = viewportHeight * 0.6;
      const plateauEnd = viewportHeight * 0.4;
      let newScale = 0;

      if (elementCenter <= plateauStart && elementCenter >= plateauEnd) {
        newScale = 1;
      } else if (elementCenter > plateauStart) {
        const openingDistance = viewportHeight - plateauStart;
        const progress = (viewportHeight - elementCenter) / openingDistance;
        newScale = progress;
      } else {
        const closingDistance = plateauEnd;
        const progress = elementCenter / closingDistance;
        newScale = progress;
      }

      const clampedScale = Math.max(0, Math.min(1, newScale));
      quickScale(clampedScale);

      // Notify parent component of scale change
      if (onScaleChange) {
        onScaleChange(clampedScale, false); // false indicates not final state
      }
    };

    window.addEventListener("scroll", handleScroll);
    handleScroll();

    return () => {
      window.removeEventListener("scroll", handleScroll);
      // Kill the quickTo tween to prevent memory leaks
      gsap.killTweensOf(logoContainerRef.current);
    };
  }, [onScaleChange]);

  return (
    <div
      ref={logoContainerRef}
      className="w-full origin-bottom scale-y-0 min-[1800px]:flex min-[1800px]:justify-center"
      // GSAP will animate the transform property, so we set the initial state here.
      style={{ transform: "scaleY(0)" }}
    >
      {/* SVG for large screens (1280px and up) */}
      <div className="hidden xl:block">
        <svg
          className="block h-auto w-full"
          width="1413"
          height="176"
          viewBox="0 0 1413 176"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M1330.98 175.629C1314.66 175.629 1300.14 171.942 1287.4 164.568C1274.89 156.971 1264.95 146.581 1257.57 133.398C1250.42 120.214 1246.85 105.02 1246.85 87.8145C1246.85 70.6091 1250.54 55.4148 1257.91 42.2314C1265.28 29.0481 1275.34 18.7695 1288.07 11.3958C1301.03 3.79859 1315.78 0 1332.32 0C1347.29 0 1360.81 3.91032 1372.87 11.731C1384.94 19.3281 1394.44 30.3887 1401.36 44.9128C1408.51 59.4368 1412.09 76.7539 1412.09 96.8641H1280.37L1285.39 92.1718C1285.39 102.45 1287.63 111.388 1292.1 118.985C1296.57 126.359 1302.49 132.057 1309.86 136.079C1317.23 140.101 1325.39 142.112 1334.33 142.112C1344.61 142.112 1353.1 139.878 1359.8 135.409C1366.5 130.716 1371.76 124.683 1375.55 117.31L1408.74 131.387C1404.04 140.325 1398.01 148.145 1390.64 154.849C1383.49 161.552 1374.88 166.691 1364.83 170.266C1355 173.842 1343.71 175.629 1330.98 175.629ZM1287.74 72.7319L1282.38 68.0395H1376.89L1371.87 72.7319C1371.87 63.5706 1369.86 56.0851 1365.83 50.2755C1361.81 44.2424 1356.67 39.7735 1350.42 36.8687C1344.38 33.7405 1338.01 32.1763 1331.31 32.1763C1324.61 32.1763 1317.9 33.7405 1311.2 36.8687C1304.5 39.7735 1298.91 44.2424 1294.44 50.2755C1289.97 56.0851 1287.74 63.5706 1287.74 72.7319Z"
            fill="black"
          />
          <path
            d="M1182.69 171.607L1181.02 140.101V85.4684C1181.02 74.0726 1179.79 64.5761 1177.33 56.9789C1175.1 49.1583 1171.3 43.2369 1165.93 39.2149C1160.79 34.9694 1153.87 32.8467 1145.15 32.8467C1137.11 32.8467 1130.07 34.5225 1124.04 37.8742C1118 41.2259 1112.87 46.4769 1108.62 53.6272L1075.77 41.5611C1079.35 34.1873 1084.04 27.3722 1089.85 21.1157C1095.88 14.6358 1103.37 9.49649 1112.31 5.69789C1121.47 1.8993 1132.42 0 1145.15 0C1161.47 0 1175.1 3.23998 1186.04 9.71994C1196.99 15.9764 1205.04 25.026 1210.18 36.8687C1215.54 48.7114 1218.22 63.012 1218.22 79.7705L1217.22 171.607H1182.69ZM1134.43 175.629C1114.32 175.629 1098.68 171.16 1087.5 162.222C1076.56 153.284 1071.08 140.66 1071.08 124.348C1071.08 106.919 1076.89 93.6242 1088.51 84.4629C1100.35 75.3015 1116.78 70.7209 1137.78 70.7209H1182.69V99.5455H1149.85C1134.88 99.5455 1124.37 101.668 1118.34 105.914C1112.31 109.936 1109.29 115.745 1109.29 123.343C1109.29 129.823 1111.86 134.962 1117 138.76C1122.36 142.336 1129.74 144.123 1139.12 144.123C1147.61 144.123 1154.99 142.224 1161.24 138.425C1167.5 134.627 1172.3 129.599 1175.65 123.343C1179.23 117.086 1181.02 110.048 1181.02 102.227H1192.08C1192.08 125.018 1187.5 143.006 1178.34 156.189C1169.17 169.149 1154.54 175.629 1134.43 175.629Z"
            fill="black"
          />
          <path
            d="M983.507 82.4517C983.507 64.3525 986.97 49.4933 993.897 37.8741C1000.82 26.2548 1009.76 17.6522 1020.71 12.066C1031.88 6.25638 1043.5 3.35156 1055.57 3.35156V39.2148C1045.29 39.2148 1035.57 40.6672 1026.41 43.572C1017.47 46.2533 1010.21 50.7223 1004.62 56.9788C999.036 63.2353 996.243 71.5028 996.243 81.7814L983.507 82.4517ZM958.704 171.607V4.02191H996.243V171.607H958.704Z"
            fill="black"
          />
          <path
            d="M841.041 175.629C824.283 175.629 809.312 171.942 796.128 164.568C783.169 156.971 773.002 146.581 765.628 133.398C758.254 120.214 754.567 105.02 754.567 87.8145C754.567 70.6091 758.143 55.4148 765.293 42.2314C772.667 29.0481 782.833 18.7695 795.793 11.3958C808.753 3.79859 823.612 0 840.371 0C857.129 0 871.989 3.79859 884.949 11.3958C897.908 18.7695 907.964 29.0481 915.114 42.2314C922.488 55.4148 926.174 70.6091 926.174 87.8145C926.174 105.02 922.599 120.214 915.449 133.398C908.299 146.581 898.244 156.971 885.284 164.568C872.324 171.942 857.576 175.629 841.041 175.629ZM841.041 141.107C850.203 141.107 858.358 138.872 865.509 134.403C872.659 129.711 878.245 123.454 882.267 115.634C886.289 107.59 888.3 98.3165 888.3 87.8145C888.3 77.3125 886.177 68.1512 881.932 60.3306C877.91 52.2865 872.324 46.03 865.174 41.5611C858.023 36.8687 849.756 34.5225 840.371 34.5225C830.986 34.5225 822.719 36.757 815.568 41.2259C808.418 45.6948 802.832 51.9514 798.81 59.9954C794.788 68.0395 792.777 77.3125 792.777 87.8145C792.777 98.3165 794.788 107.59 798.81 115.634C803.055 123.454 808.753 129.711 815.904 134.403C823.277 138.872 831.656 141.107 841.041 141.107Z"
            fill="black"
          />
          <path
            d="M474.279 171.607V4.02205H509.472L511.148 26.4784C516.287 17.764 522.879 11.1723 530.923 6.7034C538.967 2.23446 548.128 0 558.407 0C571.814 0 583.21 3.01653 592.594 9.04959C601.979 15.0826 608.794 24.244 613.04 36.5335C617.956 24.6909 624.882 15.6413 633.82 9.38477C642.758 3.12826 653.26 0 665.326 0C684.766 0 699.737 6.2565 710.239 18.7695C720.741 31.0591 725.88 50.052 725.657 75.7484V171.607H688.453V85.8035C688.453 72.3967 687.001 62.1182 684.096 54.9679C681.191 47.5941 677.281 42.4549 672.365 39.5501C667.449 36.6453 661.751 35.1929 655.271 35.1929C643.652 34.9694 634.602 39.1032 628.122 47.5941C621.866 56.0851 618.738 68.263 618.738 84.1277V171.607H581.199V85.8035C581.199 72.3967 579.746 62.1182 576.841 54.9679C574.16 47.5941 570.361 42.4549 565.446 39.5501C560.53 36.6453 554.832 35.1929 548.352 35.1929C536.733 34.9694 527.683 39.1032 521.203 47.5941C514.947 56.0851 511.818 68.263 511.818 84.1277V171.607H474.279Z"
            fill="black"
          />
          <path
            d="M364.417 175.629C348.105 175.629 333.581 171.942 320.845 164.568C308.332 156.971 298.388 146.581 291.014 133.398C283.864 120.214 280.289 105.02 280.289 87.8145C280.289 70.6091 283.976 55.4148 291.35 42.2314C298.723 29.0481 308.779 18.7695 321.515 11.3958C334.475 3.79859 349.222 0 365.757 0C380.728 0 394.247 3.91032 406.313 11.731C418.379 19.3281 427.876 30.3887 434.802 44.9128C441.953 59.4368 445.528 76.7539 445.528 96.8641H313.806L318.834 92.1718C318.834 102.45 321.068 111.388 325.537 118.985C330.006 126.359 335.927 132.057 343.301 136.079C350.675 140.101 358.831 142.112 367.768 142.112C378.047 142.112 386.538 139.878 393.241 135.409C399.945 130.716 405.196 124.683 408.994 117.31L442.176 131.387C437.484 140.325 431.451 148.145 424.077 154.849C416.927 161.552 408.324 166.691 398.269 170.266C388.437 173.842 377.153 175.629 364.417 175.629ZM321.18 72.7319L315.817 68.0395H410.335L405.307 72.7319C405.307 63.5706 403.296 56.0851 399.274 50.2755C395.252 44.2424 390.113 39.7735 383.857 36.8687C377.824 33.7405 371.455 32.1763 364.752 32.1763C358.049 32.1763 351.345 33.7405 344.642 36.8687C337.938 39.7735 332.352 44.2424 327.883 50.2755C323.414 56.0851 321.18 63.5706 321.18 72.7319Z"
            fill="black"
          />
          <path
            d="M0 171.607V4.02205H35.1929L36.8687 26.4784C42.008 17.764 48.5997 11.1723 56.6437 6.7034C64.6878 2.23446 73.8491 0 84.1277 0C97.5345 0 108.93 3.01653 118.315 9.04959C127.7 15.0826 134.515 24.244 138.76 36.5335C143.676 24.6909 150.603 15.6413 159.541 9.38477C168.479 3.12826 178.981 0 191.047 0C210.487 0 225.458 6.2565 235.96 18.7695C246.462 31.0591 251.601 50.052 251.378 75.7484V171.607H214.174V85.8035C214.174 72.3967 212.721 62.1182 209.816 54.9679C206.912 47.5941 203.001 42.4549 198.085 39.5501C193.17 36.6453 187.472 35.1929 180.992 35.1929C169.373 34.9694 160.323 39.1032 153.843 47.5941C147.587 56.0851 144.458 68.263 144.458 84.1277V171.607H106.919V85.8035C106.919 72.3967 105.467 62.1182 102.562 54.9679C99.8807 47.5941 96.0821 42.4549 91.1663 39.5501C86.2504 36.6453 80.5525 35.1929 74.0726 35.1929C62.4533 34.9694 53.4038 39.1032 46.9238 47.5941C40.6673 56.0851 37.539 68.263 37.539 84.1277V171.607H0Z"
            fill="black"
          />
        </svg>
      </div>

      {/* Fallback image for smaller screens (below 1280px) */}
      <CdnImage
        src="/homepage/footer_image.png"
        alt="memorae"
        className="mx-auto block h-auto w-full xl:hidden"
        width={377}
        height={110}
      />
    </div>
  );
};
export default ScalingText;
